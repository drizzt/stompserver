require 'rubygems'
require 'stomp_server'
require 'frame_journal'
require 'optparse'

opts = OptionParser.new

port = 61613
bind = "127.0.0.1"
bind = "localhost"
storage = ".stompserver"

opts.on("-p", "--port=PORT", Integer, "Change the port (default: 61613)") {|p| port = p}
opts.on("-b", "--bind=ADDR", String, "Change the binding adapter (default: localhost)") {|a| bind = a}
opts.on("-s", "--storage=DIR", String, "Change the storage directory (default: .stompserver)") {|s| storage = s}
opts.on("-h", "--help", "Show this message") do
  puts opts
  exit
end

puts opts.parse(ARGV)

#$DEBUG=true 
#StompServer.setup(qs=MemoryQueue.new)
#StompServer.setup(qs=BDBQueue.new(storage))
StompServer.setup(qs=FileQueue.new(storage))
EventMachine::run do
  puts "Stomp Server starting on port #{port}"
  EventMachine.start_server bind, port, StompServer
end
